{% extends "template.html" %}

{% load filters %}
{% load crispy_forms_tags %}

{% block head %}
  <script language="javascript">
   check_menu_visibility = function() {
     var hidden = true;
     var menu = $('#actions_menu');
     var count = 0;

     $('input[name="local_files"]').each(function() {
       if ($(this).prop('checked')) {
         hidden = false;
         count += 1;
       }
     });

     $('input[name="local_filename"]').prop('value', count + ' file(s) selected for processing')

     if (hidden)
       menu.hide();
     else
       menu.show();
   }

   {% if mode == 'list' %}
   // Toggle visibility of the menu depending on whether something is selected
   $(function(){
     $('input[name="local_files"]').on('change', check_menu_visibility);
     check_menu_visibility();
   });

   // Select all
   $(function(){
     $('input[name="select_all"]').on('change', function() {
       $('input[name="local_files"]').prop('checked', $(this).prop('checked'));
       check_menu_visibility();
     });
   });
   {% endif %}
  </script>
{% endblock %}

{% block ptitle %}{% if path %}{{ path }}{% else %}Files{% endif %} : STDWeb{% endblock %}

{% block title %}File browser{% endblock %}

{% block content %}

  {% if breadcrumb %}
    <!-- Display breadcrumb with clickable path elements -->
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        {% if is_task_browser %}
          <li class="breadcrumb-item">
            <a href="{% url 'tasks' id=task_id %}">Task {{ task_id }}</a>
          </li>
        {% endif %}

        {% for bread in breadcrumb %}
          <li class="breadcrumb-item">
            {% if bread.path %}
              {% if is_task_browser %}
                <a href="{% url 'task_files' id=task_id path=bread.path %}">{{ bread.name }}</a>
              {% else %}
                <a href="{% url 'files' path=bread.path %}">{{ bread.name }}</a>
              {% endif %}
            {% else %}
              {{ bread.name }}
            {% endif %}
          </li>
        {% endfor %}
      </ol>
    </nav>
  {% endif %}

  {% if mode == 'list' %}
    <!-- Display directory listing -->

    {% if not files %}
      Nothing to list
    {% else %}
      <!-- <p>
      {{ files|length }} entries
      </p> -->

      {% if not is_task_browser %}
      <form method='POST' action="{% url 'upload' %}">
      {% endif %}

      <div class="list-group mb-4">

        <div class="list-group-item d-flex bg-light">
          {% if not is_task_browser %}
            <input class="form-check-input" type="checkbox" name="select_all" title="Select all"/>
          {% endif %}
          <span class="ms-auto me-auto"><strong>Filename</strong></span>
          <span class="pull-right me-4"><strong>Size</strong></span>
        </div>

        {% for file in files %}
          <div class="list-group-item">
            {% if file.type == 'fits' and not is_task_browser %}
              <input class="form-check-input" type="checkbox" name="local_files" value="{{ file.path }}"/>
            {% else %}
              <span class="w-1 d-inline-block"></span>
            {% endif %}

            <i class="ms-2 me-2 fa fa-{% if file.type == 'dir' %}folder-open-o{% elif file.type == 'up' %}level-up{% elif file.type == 'text' %}file-text-o{% elif file.type == 'file' %}file-o{% else %}file-image-o{% endif %}"></i>

            {% if is_task_browser %}
              <a href='{% url 'task_files' id=task_id path=file.path %}' class="text-decoration-none text-body">
                {{ file.name }}
              </a>
            {% else %}
              <a href='{% url 'files' path=file.path %}' class="text-decoration-none text-body">
                {{ file.name }}
              </a>
            {% endif %}

            {% if file.type != 'dir' and file.type != 'up' %}
              <span class="pull-right">{{ file.size|naturalsize }}</span>
            {% endif %}
          </div>

        {% endfor %}

      </div>

      {% if not is_task_browser %}
      <div id='actions_menu'>
        <h3>Process selected files</h3>
        {% crispy form %}
      </div>

      </form>
      {% endif %}

    {% endif %}

  {% else %}
    <!-- Display single file - starts with some metadata -->
    <ul>
      <li>Path: <b>
        {% if is_task_browser %}
          <a href="{% url 'task_download' id=task_id path=path %}"><i class="fa fa-download"></i> {{ path }}</a>
        {% else %}
          <a href="{% url 'download' path=path %}"><i class="fa fa-download"></i> {{ path }}</a>
        {% endif %}
      </b></li>
      <li>Size: <b>{{ stat.st_size }}</b> bytes / {{ stat.st_size|naturalsize }}</li>
      <li>Last modified: <b>{{ time.iso }}</b></li>
      <li><b>{{ mime }}</b> : {{ magic_info }}</li>
    </ul>

    {% if mode == 'text' %}
      <!-- Display text file contents -->

      <div class="card mb-2">
        <div class="card-body pr-2 pl-2 pt-2 pb-2">
          <pre><code>{{ contents }}</code></pre>
        </div>
      </div>

    {% elif mode == 'table' %}
      <!-- Display table -->

      <h2>
        Tabular data with {{ table|length }} row(s)
      </h2>

      {% if table|length > 100 %}
        <p class="text-muted">
          First 100 rows are shown below
        </p>
      {% endif %}

      <!-- <div class="overflow-auto mb-2"> -->
      <pre style="white-space: pre-wrap;">{{ table|show_table:100 }}</pre>
      <!-- </div> -->

    {% elif mode == 'image' %}
      <!-- Display image inline -->

      <div class="text-center mb-2">
        {% if is_task_browser %}
          <img src="{% url 'task_view' id=task_id path=path %}" class="img-fluid img-thumbnail" alt="{{ path }}"/>
        {% else %}
          <img src="{% url 'view' path=path %}" class="img-fluid img-thumbnail" alt="{{ path }}"/>
        {% endif %}
      </div>

    {% elif mode == 'fits' %}
      <!-- Display FITS inline -->

      <div class="mb-4">
        {% if not is_task_browser %}
          <!-- File upload form -->
          <form method='POST' action="{% url 'upload' %}">

          {% crispy form %}
        {% endif %}

          {% for hdu in fitsfile %}
            <div class="mt-4">
              <!-- Full FITS header -->
              <div class="card mb-2">
                <h5 class="card-header pt-2 pb-2 collapse-chevron collapsed"
                    data-bs-toggle="collapse" data-bs-target="#collapseHeader{{ forloop.counter0 }}"
                    aria-expanded="false"
                    aria-controls="collapseHeader{{ forloop.counter0 }}">
                  <i class="fa fa-list"></i>
                  {{ hdu.name }}
                </h5>

                <div class="collapse {% if hdu.data is none %}show{% endif %}" id="collapseHeader{{ forloop.counter0 }}">
                  <div class="card-body pr-2 pl-2 pt-2 pb-2">
                    <pre>{{ hdu.header | header_to_string }}</pre>
                  </div>
                </div>
              </div>

              {% if hdu.data is not none %}
                {% if fitsfile|length > 1 and not is_task_browser %}
                  <button class="btn btn-warning mt-2 mb-2" type="submit" name="ext" value="{{ forloop.counter0 }}">Process this extension</button>
                {% endif %}
                <div class="text-center">
                  {% if is_task_browser %}
                    <img src="{% url 'task_preview' id=task_id path=path %}?ext={{ forloop.counter0 }}"
                         class="img-fluid img-thumbnail stdview-image"
                         data-stretch
                         data-grid
                         data-zoom
                         alt="{{ path }}"/>
                  {% else %}
                    <img src="{% url 'preview' path=path %}?ext={{ forloop.counter0 }}"
                         class="img-fluid img-thumbnail stdview-image"
                         data-stretch
                         data-grid
                         data-zoom
                         alt="{{ path }}"/>
                  {% endif %}
                </div>
              {% endif %}

            </div>
          {% endfor %}

        {% if not is_task_browser %}
        </form>
        {% endif %}
      </div>

    {% elif mode == 'cutout' %}

      {% include 'block_cutout.html' with path=path cutout=cutout fitsfile=fitsfile %}

    {% else %}
      <p>
        Cannot preview file
      </p>
    {% endif %}

  {% endif %}

{% endblock %}
