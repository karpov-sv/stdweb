{% extends "template.html" %}

{% load el_pagination_tags %}
{% load crispy_forms_tags %}
{% load filters %}

{% block ptitle %}Lightcurves : STDWeb{% endblock %}

{% block head %}
  {% include "popup_image.html" %}
{% endblock %}

{% block title %}Search around sky position{% endblock %}

{% block content %}

  <div class="mb-4">
    {% crispy form %}
  </div>

  {% if tasks %}

    <div class="mb-3 d-flex justify-content-between align-items-center">
      <div>
        Search position:
        <strong>{{ search_ra|to_sexadecimal_hours }} {{ search_dec|to_sexadecimal_plus }}</strong>
        (<strong>{{ search_ra|floatformat:4 }} {{ search_dec|numformat:'+.4f' }}</strong>)
        {% if search_sr0 %}
          Radius: <strong>{{ search_sr0|numformat:'.1f' }} arcsec</strong>
        {% endif %}
        {% if tasks %}
          Results: <strong>{{ tasks|length }}</strong>
        {% endif %}
      </div>
      <div>
        <a class="btn btn-sm btn-outline-success"
           href="{% url 'lightcurve_download_votable' %}?{{ request.GET.urlencode }}">
          <i class="fa fa-file-download"></i> Download VOTable
        </a>
        <button id="load-all-photometry" class="btn btn-sm btn-outline-secondary">
          <i class="fa fa-download"></i> Load All Photometry
        </button>
      </div>
    </div>

    {% paginate 100 tasks %}

    <div>

      {% for item in tasks %}
        {% with task=item.task %}

          <div class="card mb-4" style="max-width: 100%;">
            <div class="row g-0">
              <div class="col-md">
                <div class="card-body">

                  <span class="badge bg-{% if 'failed' in task.state or 'cancelled' in task.state %}danger{% else %}primary{% endif %} rounded-pill card-badge-right border">
                    {{ task.state }}
                  </span>

                  <a href="{% url 'tasks' id=task.id %}" class="text-decoration-none text-body">
                    <span class="card-badge-left d-flex">
                      <span class="badge bg-light rounded-pill border text-dark">
                        Task {{ task.id }}
                      </span>
                      <span class="badge bg-info-subtle rounded-pill border text-dark ms-2">
                        {{ task.user }}
                      </span>
                    </span>

                    <h5 class="card-title mb-1">
                      {{ task.original_name|linebreaksimple }}
                    </h5>
                    {% if task.title %}
                      <p class="card-text text-body-secondary fst-italic ps-2 border-start border-4 border-secondary"
                         style="--bs-border-opacity: .3;">
                        {{ task.title|linebreaksimple }}
                      </p>
                    {% endif %}
                  </a>
                  {% if task.ra is not None and task.dec is not None and task.radius is not None and task.config.pixscale %}
                    <p class="card-text mt-2 mb-1">
                      Center: <span class="fw-bold" title="{{ task.ra|to_sexadecimal_hours }} {{ task.dec|to_sexadecimal_plus }}">
                      {{ task.ra|floatformat:4 }} {{ task.dec|numformat:'+.4f' }}
                      </span>
                      Radius: <span class="fw-bold" title="{{ task.radius|to_sexadecimal }}">{{ task.radius|floatformat:2 }}</span> deg.
                      Scale: <span class="fw-bold">{{ task.config.pixscale|multiply:3600|floatformat:2 }}</span> arcsec/pix.
                    </p>
                  {% endif %}

                  <p class="card-text mb-1">
                    {% if task.config.target_ra is not None and task.config.target_dec is not None %}
                      Target: <span class="fw-bold">{{ task.config.target_ra|to_sexadecimal_hours }} {{ task.config.target_dec|to_sexadecimal_plus }}</span>
                    {% endif %}

                    {% if task.config.time %}
                      Time: <span class="fw-bold">{{ task.config.time }}</span>
                    {% endif %}

                    {% if task.config.filter %}
                      Filter: <span class="fw-bold">{{ task.config.filter }}</span>
                    {% endif %}

                    {% if task.config.mag_limit %}
                      Limit: <span class="fw-bold">{{ task.config.mag_limit|floatformat:2 }}</span>
                    {% endif %}

                  </p>

                  <!-- <p class="card-text"> -->
                    <div class="photometry-container mt-2" data-task-id="{{ task.id }}">
                      <button class="btn btn-sm btn-outline-primary load-photometry-btn"
                              data-task-id="{{ task.id }}"
                              data-ra="{{ search_ra }}"
                              data-dec="{{ search_dec }}"
                              data-radius="{% if search_sr0 %}{{ search_sr0 }}{% else %}5{% endif %}"
                              data-targets-only="{% if targets_only %}true{% else %}false{% endif %}">
                        Load Photometry
                      </button>
                      <div class="photometry-loading d-none">
                        <span class="spinner-border spinner-border-sm" role="status"></span>
                        Loading measurements...
                      </div>
                      <div class="photometry-data"></div>
                    </div>
                    <!-- </p> -->

                </div>
              </div>

              {% if show_images and task.ra is not None and task.dec is not None %}
                <div class="col-md-auto ms-3">
                  {# Cutout thumbnail #}
                  <img
                  src="{% url 'task_preview' id=task.id path='image.fits' %}?timestamp={{ task.modified|unix }}&sub_ra={{ search_ra }}&sub_dec={{ search_dec }}&sub_sr={{ sub_sr }}&width=300"
                  alt="Cutout"
                  class="img-fluid rounded-end cutout-image"
                  style="width: 300px; height: 300px; object-fit: cover; cursor: pointer;"
                  title="Click to enlarge"
                  {# Popup image #}
                  onclick="popupImage(event,
                  '{% url 'task_preview' id=task.id path='image.fits' %}?timestamp={{ task.modified|unix }}&sub_ra={{ search_ra }}&sub_dec={{ search_dec }}&sub_sr={{ sub_sr }}&width=1024',
                  'Task {{ task.id }}: {{ task.original_name }}',
                  true, 'stdview-image', {'data-stretch':1,
                  'data-mark-ra':'{{ search_ra }}',
                  'data-mark-dec':'{{ search_dec }}',
                  'data-mark-radius': '{{ search_sr0|divide:3600|divide:task.config.pixscale }}',
                  'data-grid':1, 'data-zoom':1, 'data-obj':1, 'data-smooth':1})"
                  {# Placeholder for loading error #}
                  onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjUwJSIgeT0iNDUlIiBmb250LWZhbWlseT0iQXJpYWwsc2Fucy1zZXJpZiIgZm9udC1zaXplPSI0OCIgZmlsbD0iI2FkYjViZCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+TtzwvdGV4dD48dGV4dCB4PSI1MCUiIHk9IjYwJSIgZm9udC1mYW1pbHk9IkFyaWFsLHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM2Yzc1N2QiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkN1dG91dCBVbmF2YWlsYWJsZTwvdGV4dD48L3N2Zz4='; this.style.cursor='default'; this.onclick=null;"
                  />
                </div>
              {% endif %}

            </div>
          </div>



        {% endwith %}
      {% endfor %}

    </div>

    {% show_pages %}

  {% elif form.is_bound %}
    <p class="text-muted">No tasks found covering this position. Try adjusting the search coordinates or check that tasks have been processed through the photometry stage.</p>
  {% else %}
    <p class="text-muted">Enter coordinates and radius to search for photometric measurements covering a specific sky position.</p>
  {% endif %}

  {# Supporting JavaScript #}

  <script>
   $(document).ready(function() {

     // Handle "Load All Photometry" button click
     $('#load-all-photometry').on('click', function() {
       var $loadAllBtn = $(this);
       var $loadButtons = $('.load-photometry-btn').not('.d-none');
       var totalButtons = $loadButtons.length;
       var loadedCount = 0;

       if (totalButtons === 0) {
         return;
       }

       // Disable the button and update text
       $loadAllBtn.prop('disabled', true);
       $loadAllBtn.html('<i class="fa fa-spinner fa-spin"></i> Loading ' + loadedCount + '/' + totalButtons);

       // Sequential loading function
       function loadNext(index) {
         if (index >= totalButtons) {
           // All done
           $loadAllBtn.prop('disabled', false);
           $loadAllBtn.html('<i class="fa fa-check"></i> All Loaded');
           setTimeout(function() {
             $loadAllBtn.html('<i class="fa fa-download"></i> Load All Photometry');
           }, 2000);
           return;
         }

         var $btn = $loadButtons.eq(index);
         var $container = $btn.closest('.photometry-container');
         var $loading = $container.find('.photometry-loading');
         var $data = $container.find('.photometry-data');

         // Get parameters from data attributes
         var taskId = $btn.data('task-id');
         var ra = $btn.data('ra');
         var dec = $btn.data('dec');
         var radius = $btn.data('radius');
         var targetsOnly = $btn.data('targets-only');

         // Show loading indicator
         $btn.addClass('d-none');
         $loading.removeClass('d-none');

         // AJAX request
         $.ajax({
           url: "{% url 'lightcurve_photometry_html' id=0 %}".replace('/0', '/' + taskId),
           method: 'GET',
           data: {
             ra: ra,
             dec: dec,
             radius: radius,
             targets_only: targetsOnly
           },
           dataType: 'html',

           success: function(html) {
             $data.html(html);
             $loading.addClass('d-none');
             loadedCount++;
             $loadAllBtn.html('<i class="fa fa-spinner fa-spin"></i> Loading ' + loadedCount + '/' + totalButtons);
             // Load next item
             loadNext(index + 1);
           },

           error: function(xhr, status, error) {
             $data.html('<div class="alert alert-danger">Error loading photometry: ' + error + '</div>');
             $loading.addClass('d-none');
             $btn.removeClass('d-none');
             loadedCount++;
             $loadAllBtn.html('<i class="fa fa-spinner fa-spin"></i> Loading ' + loadedCount + '/' + totalButtons);
             // Continue to next item even on error
             loadNext(index + 1);
           }
         });
       }

       // Start sequential loading
       loadNext(0);
     });

     // Handle "Load Photometry" button clicks
     $('.load-photometry-btn').on('click', function() {
       var $btn = $(this);
       var $container = $btn.closest('.photometry-container');
       var $loading = $container.find('.photometry-loading');
       var $data = $container.find('.photometry-data');

       // Get parameters from data attributes
       var taskId = $btn.data('task-id');
       var ra = $btn.data('ra');
       var dec = $btn.data('dec');
       var radius = $btn.data('radius');
       var targetsOnly = $btn.data('targets-only');

       // Show loading indicator
       $btn.addClass('d-none');
       $loading.removeClass('d-none');

       // AJAX request
       $.ajax({
         url: "{% url 'lightcurve_photometry_html' id=0 %}".replace('/0', '/' + taskId),
         method: 'GET',
         data: {
           ra: ra,
           dec: dec,
           radius: radius,
           targets_only: targetsOnly
         },
         dataType: 'html',

         success: function(html) {
           // Directly insert pre-rendered HTML
           $data.html(html);
           $loading.addClass('d-none');
         },

         error: function(xhr, status, error) {
           $data.html('<div class="alert alert-danger">Error loading photometry: ' + error + '</div>');
           $loading.addClass('d-none');
           $btn.removeClass('d-none');
         }
       });
     });

   });
  </script>

{% endblock %}
