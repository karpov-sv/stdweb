{% extends "template.html" %}

{% load el_pagination_tags %}
{% load crispy_forms_tags %}
{% load filters %}

{% block ptitle %}Tasks : STDWeb{% endblock %}

{% block title %}Tasks{% endblock %}

{% block head %}
  <script language="javascript">
   check_menu_visibility = function() {
     var hidden = true;
     var menu = $('#actions_menu');
     var count = 0;

     $('input[name="tasks"]').each(function() {
       if ($(this).prop('checked')) {
         hidden = false;
         count += 1;
       }
     });

     if (hidden)
       menu.hide();
     else
       menu.show();
   }

   // Toggle visibility of the menu depending on whether something is selected
   $(function(){
     $('input[name="tasks"]').on('change', check_menu_visibility);
     check_menu_visibility();
   });

   // Submit the form on changing the checkbox
   $(function(){
     $('#id_show_all').on('change', function(){
       $(this).closest('form').submit();
     });
   });
  </script>
{% endblock %}

{% block content %}

  <div>
    {% crispy form %}
  </div>

  {% if tasks %}

    <form action="{% url 'tasks_actions' %}" method="POST">
      {% csrf_token %}
      <input type="hidden" name="referer" value="{{ referer }}"/>

      {% paginate 10 tasks %}

      <div class="list-group mb-4">
        {% for task in tasks %}
          <div class=" list-group-item list-group-item-action d-flex justify-content-between align-items-start">
            <div class="me-2">
              <input class="form-check-input" type="checkbox" name="tasks" value="{{ task.id }}">
            </div>
            <div class="ms-1 me-2">
              {{ task.id }}
            </div>
            <div class="ms-2 me-auto">
              <a href="{% url 'tasks' id=task.id %}" class="text-decoration-none text-body">
                <div class="fw-bold">{{ task.original_name }}</div>

                {% if task.title %}
                  <div class="fst-italic">{{ task.title }}</div>
                {% endif %}

                <div>
                  {% if task.config.target_ra or task.config.target_dec %}
                    Target: <span class="fw-bold">{{ task.config.target_ra|to_sexadecimal_hours }} {{ task.config.target_dec|to_sexadecimal_plus }}</span>
                  {% endif %}

                  {% if task.config.mag_limit %}
                    Detection limit: <span class="fw-bold">{{ task.config.mag_limit|floatformat:2 }}</span>
                  {% endif %}
                </div>

                <small class="me-2 badge bg-info">{{ task.user|user }}</small>
                <small class="me-2">Created: <span class="fst-italic">{{ task.created|timestamp }}</span></small>
                <small class="me-2">Modified: <span class="fst-italic">{{ task.modified|timestamp }}</span></small>
              </a>
            </div>
            <span class="badge bg-{% if 'failed' in task.state %}danger{% else %}primary{% endif %} rounded-pill">{{ task.state }}</span>
          </div>
        {% endfor %}
      </div>

      <div id='actions_menu'>
        <span class="ms-2 me-2">Actions on selected tasks:</span>
        <button type="submit" name="action" value="archive" class="btn btn-info"
                title="Delete all generated files">Archive</button>
        <button type="submit" name="action" value="cleanup" class="btn btn-warning"
                title="Delete all processing results and configurations">Cleanup</button>
        <button type="submit" name="action" value="delete" class="btn btn-danger ms-4"
                title="Permanently delete this task">Delete</button>
      </div>

    </form>

    {% show_pages %}

  {% else %}
    No tasks found
  {% endif %}

{% endblock %}
